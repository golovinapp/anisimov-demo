<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°—Ç—Ä–æ–π–ö–æ–Ω—Ç—Ä–æ–ª—å ‚Äî CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        
        .kanban-card { 
            transition: transform 0.15s, box-shadow 0.15s, opacity 0.15s;
            user-select: none;
        }
        .kanban-card.dragging { 
            opacity: 0.8; 
            transform: scale(1.02) rotate(2deg); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            z-index: 1000;
            position: fixed;
            pointer-events: none;
        }
        .kanban-card.drag-source {
            opacity: 0.3;
        }
        .kanban-column.drag-over { 
            background: rgba(59, 130, 246, 0.1) !important; 
            border: 2px dashed #3b82f6; 
        }
        
        .kanban-container { 
            display: flex; 
            gap: 12px; 
            overflow-x: auto; 
            padding-bottom: 16px; 
            scroll-snap-type: x mandatory; 
            -webkit-overflow-scrolling: touch; 
        }
        .kanban-column { 
            flex: 0 0 auto; 
            scroll-snap-align: start; 
            transition: background 0.2s, border 0.2s; 
        }
        
        @media (max-width: 639px) { 
            .kanban-column { width: calc(100vw - 32px); min-width: calc(100vw - 32px); } 
        }
        @media (min-width: 640px) and (max-width: 1023px) { 
            .kanban-column { width: calc(50vw - 24px); min-width: 280px; } 
        }
        @media (min-width: 1024px) { 
            .kanban-column { flex: 1; min-width: 240px; max-width: 320px; } 
            .kanban-container { justify-content: center; } 
        }
        
        .filter-pill { transition: all 0.2s; white-space: nowrap; }
        .filter-pill.active { background: #3b82f6; color: white; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3); }
        
        .column-dots { display: flex; justify-content: center; gap: 6px; padding: 8px 0; }
        .column-dot { width: 8px; height: 8px; border-radius: 50%; background: #d1d5db; transition: all 0.2s; cursor: pointer; }
        .column-dot.active { background: #3b82f6; width: 24px; border-radius: 4px; }
        @media (min-width: 1024px) { .column-dots { display: none; } }
        
        .modal-overlay { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .modal-content { animation: slideUp 0.2s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .comment-item { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        
        ::-webkit-scrollbar { height: 4px; width: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        #app { max-width: 100%; margin: 0 auto; }
        @media (min-width: 1024px) { #app { max-width: 1200px; } }
        
        /* Long press indicator */
        .kanban-card.press-active {
            transform: scale(0.98);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app" class="bg-white min-h-screen flex flex-col"></div>

    <script>
        // === STATE ===
        let activeScreen = 'kanban';
        let activeRole = 'manager';
        let activeFilter = 'all';
        let activeColumnIndex = 0;
        let selectedCardId = null;

        // Drag state
        let isDragging = false;
        let draggedCardId = null;
        let draggedCardData = null;
        let sourceColumn = null;
        let dragClone = null;
        let dragSourceElement = null;

        // Touch state
        let touchStartX = 0;
        let touchStartY = 0;
        let longPressTimer = null;
        let touchedCard = null;
        let isLongPress = false;

        const LONG_PRESS_DURATION = 400; // ms
        const MOVE_THRESHOLD = 10; // px

        // === DATA ===
        let kanbanData = {
            new: [
                { id: 1, client: '–û–û–û "–°—Ç—Ä–æ–π–∫–∞"', type: 'sypuchka', material: '–©–µ–±–µ–Ω—å 20—Ç', price: '45 000 ‚ÇΩ', address: '—É–ª. –õ–µ–Ω–∏–Ω–∞, 15', status: 'unpaid', phone: '+7 900 123-45-67', comments: [
                    { author: '–ú–µ–Ω–µ–¥–∂–µ—Ä', text: '–ö–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å–∏–ª –¥–æ—Å—Ç–∞–≤–∫—É –¥–æ 10:00', time: '10:30' },
                ] },
                { id: 2, client: '–ò–ü –°–∏–¥–æ—Ä–æ–≤', type: 'tech', material: '–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä 4—á', price: '28 000 ‚ÇΩ', address: '–ü—Ä–æ–º–∑–æ–Ω–∞, —É—á. 8', status: 'unpaid', phone: '+7 900 234-56-78', comments: [] },
                { id: 7, client: '–¢–°–ñ "–£—é—Ç–Ω—ã–π"', type: 'snow', material: '–£–±–æ—Ä–∫–∞ 500–º¬≤', price: '12 000 ‚ÇΩ', address: '—É–ª. –ú–∏—Ä–∞, 42', status: 'unpaid', phone: '+7 900 111-22-33', comments: [] },
            ],
            inProgress: [
                { id: 3, client: '–ò–≤–∞–Ω–æ–≤ –ê.–ü.', type: 'snow', material: '–£–±–æ—Ä–∫–∞ —Å–Ω–µ–≥–∞', price: '15 000 ‚ÇΩ', address: '–¢–¶ "–ú–µ–≥–∞"', status: 'partial', phone: '+7 900 345-67-89', comments: [
                    { author: '–í–æ–¥–∏—Ç–µ–ª—å', text: '–í—ã–µ—Ö–∞–ª –Ω–∞ –æ–±—ä–µ–∫—Ç', time: '08:15' },
                    { author: '–ú–µ–Ω–µ–¥–∂–µ—Ä', text: '–ö–ª–∏–µ–Ω—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –ø—Ä–∏—ë–º', time: '09:40' },
                ] },
                { id: 8, client: '–ë–∞–∑–∞ "–°—Ç—Ä–æ–∏—Ç–µ–ª—å"', type: 'sypuchka', material: '–ü–µ—Å–æ–∫ 40—Ç', price: '62 000 ‚ÇΩ', address: '–ü—Ä–æ–º–∑–æ–Ω–∞, 12', status: 'partial', phone: '+7 900 222-33-44', comments: [] },
            ],
            awaitingPayment: [
                { id: 4, client: '–û–û–û "–ë–µ—Ç–æ–Ω+"', type: 'sypuchka', material: '–ü–µ—Å–æ–∫ 30—Ç', price: '52 000 ‚ÇΩ', address: '–ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏, –¥.7', status: 'unpaid', daysOverdue: 5, phone: '+7 900 456-78-90', comments: [
                    { author: '–ë—É—Ö–≥–∞–ª—Ç–µ—Ä', text: '–í—ã—Å—Ç–∞–≤–ª–µ–Ω —Å—á—ë—Ç ‚Ññ1234', time: '14:00' },
                    { author: '–ë—É—Ö–≥–∞–ª—Ç–µ—Ä', text: '–ù–∞–ø–æ–º–Ω–∏–ª–∞ –æ–± –æ–ø–ª–∞—Ç–µ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É', time: '16:20' },
                ] },
                { id: 9, client: '–£–ø—Ä–∞–≤–∞ —Ä–∞–π–æ–Ω–∞', type: 'snow', material: '–£–±–æ—Ä–∫–∞ –¥–≤–æ—Ä–æ–≤', price: '85 000 ‚ÇΩ', address: '–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ä-–Ω', status: 'unpaid', daysOverdue: 3, phone: '+7 900 333-44-55', comments: [] },
            ],
            completed: [
                { id: 5, client: '–ñ–ö "–°–æ–ª–Ω–µ—á–Ω—ã–π"', type: 'tech', material: '–ù–∞—Å–æ—Å 8—á', price: '64 000 ‚ÇΩ', address: '–ñ–ö –°–æ–ª–Ω–µ—á–Ω—ã–π', status: 'paid', phone: '+7 900 567-89-01', comments: [
                    { author: '–ú–µ–Ω–µ–¥–∂–µ—Ä', text: '–†–∞–±–æ—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –≤ —Å—Ä–æ–∫', time: '17:00' },
                    { author: '–ë—É—Ö–≥–∞–ª—Ç–µ—Ä', text: '–û–ø–ª–∞—Ç–∞ –ø–æ—Å—Ç—É–ø–∏–ª–∞', time: '18:30' },
                ] },
                { id: 6, client: '–î–æ—Ä—Å—Ç—Ä–æ–π', type: 'sypuchka', material: '–©–µ–±–µ–Ω—å 50—Ç', price: '112 000 ‚ÇΩ', address: '–¢—Ä–∞—Å—Å–∞ –ú4', status: 'paid', phone: '+7 900 444-55-66', comments: [] },
            ]
        };

        const columnKeys = ['new', 'inProgress', 'awaitingPayment', 'completed'];

        // === HELPERS ===
        const getStatusColor = (status) => ({
            paid: 'bg-green-100 border-green-400 text-green-800',
            partial: 'bg-yellow-100 border-yellow-400 text-yellow-800',
            unpaid: 'bg-red-100 border-red-400 text-red-800'
        }[status] || 'bg-gray-100 border-gray-400');

        const getTypeIcon = (type) => ({ sypuchka: 'ü™®', tech: 'üöú', snow: '‚ùÑÔ∏è' }[type] || 'üì¶');

        const getFilteredData = (items) => activeFilter === 'all' ? items : items.filter(item => item.type === activeFilter);

        const getColumnCount = (key) => getFilteredData(kanbanData[key]).length;

        const findCard = (cardId) => {
            for (const key of columnKeys) {
                const card = kanbanData[key].find(c => c.id === cardId);
                if (card) return { card, column: key };
            }
            return null;
        };

        const getCurrentTime = () => new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

        const getRoleName = () => ({ manager: '–ú–µ–Ω–µ–¥–∂–µ—Ä', accountant: '–ë—É—Ö–≥–∞–ª—Ç–µ—Ä', owner: '–°–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫', driver: '–í–æ–¥–∏—Ç–µ–ª—å' }[activeRole] || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');

        // === DRAG & DROP (Desktop) ===
        window.handleDragStart = (e, cardId, columnKey) => {
            isDragging = true;
            draggedCardId = cardId;
            sourceColumn = columnKey;
            draggedCardData = kanbanData[columnKey].find(c => c.id === cardId);
            e.target.classList.add('drag-source');
            e.dataTransfer.effectAllowed = 'move';
        };

        window.handleDragEnd = (e) => {
            e.target.classList.remove('drag-source');
            document.querySelectorAll('.kanban-column').forEach(col => col.classList.remove('drag-over'));
            isDragging = false;
            draggedCardId = null;
            draggedCardData = null;
            sourceColumn = null;
        };

        window.handleDragOver = (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; };
        
        window.handleDragEnter = (e) => { e.preventDefault(); e.currentTarget.classList.add('drag-over'); };
        
        window.handleDragLeave = (e) => {
            if (!e.currentTarget.contains(e.relatedTarget)) e.currentTarget.classList.remove('drag-over');
        };

        window.handleDrop = (e, targetColumn) => {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            if (draggedCardId && sourceColumn && sourceColumn !== targetColumn) {
                kanbanData[sourceColumn] = kanbanData[sourceColumn].filter(c => c.id !== draggedCardId);
                const statusMap = { 'new': 'unpaid', 'inProgress': 'partial', 'awaitingPayment': 'unpaid', 'completed': 'paid' };
                draggedCardData.status = statusMap[targetColumn];
                kanbanData[targetColumn].push(draggedCardData);
                render();
            }
        };

        // === TOUCH HANDLING (Mobile) ===
        window.handleCardTouchStart = (e, cardId, columnKey) => {
            const touch = e.touches[0];
            touchStartX = touch.clientX;
            touchStartY = touch.clientY;
            touchedCard = { id: cardId, column: columnKey, element: e.currentTarget };
            isLongPress = false;

            // Start long press timer
            longPressTimer = setTimeout(() => {
                isLongPress = true;
                startDrag(touch.clientX, touch.clientY);
            }, LONG_PRESS_DURATION);

            // Visual feedback
            e.currentTarget.classList.add('press-active');
        };

        window.handleCardTouchMove = (e) => {
            if (!touchedCard) return;

            const touch = e.touches[0];
            const deltaX = Math.abs(touch.clientX - touchStartX);
            const deltaY = Math.abs(touch.clientY - touchStartY);

            // If moved before long press, cancel drag initiation (allow scroll)
            if (!isLongPress && (deltaX > MOVE_THRESHOLD || deltaY > MOVE_THRESHOLD)) {
                cancelLongPress();
                return;
            }

            // If dragging, move the clone
            if (isDragging && dragClone) {
                e.preventDefault(); // Prevent scroll only when dragging
                dragClone.style.left = (touch.clientX - dragClone.offsetWidth / 2) + 'px';
                dragClone.style.top = (touch.clientY - 40) + 'px';

                // Highlight column under touch
                updateDropTarget(touch.clientX, touch.clientY);
            }
        };

        window.handleCardTouchEnd = (e) => {
            const wasDragging = isDragging;
            const wasLongPress = isLongPress;
            const touch = e.changedTouches[0];
            
            // Calculate total movement
            const deltaX = Math.abs(touch.clientX - touchStartX);
            const deltaY = Math.abs(touch.clientY - touchStartY);
            const didMove = deltaX > MOVE_THRESHOLD || deltaY > MOVE_THRESHOLD;

            cancelLongPress();

            if (wasDragging) {
                // Complete the drag
                completeDrag(touch.clientX, touch.clientY);
            } else if (!wasLongPress && !didMove && touchedCard) {
                // Short tap without movement - open modal
                openCardModal(touchedCard.id);
            }
            // If didMove but not dragging = was scrolling, do nothing

            // Cleanup
            if (touchedCard?.element) {
                touchedCard.element.classList.remove('press-active');
            }
            touchedCard = null;
        };

        function startDrag(x, y) {
            if (!touchedCard) return;

            isDragging = true;
            draggedCardId = touchedCard.id;
            sourceColumn = touchedCard.column;
            draggedCardData = kanbanData[sourceColumn].find(c => c.id === draggedCardId);
            dragSourceElement = touchedCard.element;

            // Create clone
            dragClone = dragSourceElement.cloneNode(true);
            dragClone.classList.add('dragging');
            dragClone.style.width = dragSourceElement.offsetWidth + 'px';
            dragClone.style.left = (x - dragSourceElement.offsetWidth / 2) + 'px';
            dragClone.style.top = (y - 40) + 'px';
            document.body.appendChild(dragClone);

            // Dim source
            dragSourceElement.classList.add('drag-source');
            dragSourceElement.classList.remove('press-active');

            // Haptic feedback if available
            if (navigator.vibrate) navigator.vibrate(50);
        }

        function updateDropTarget(x, y) {
            document.querySelectorAll('.kanban-column').forEach(col => col.classList.remove('drag-over'));
            
            const elemBelow = document.elementFromPoint(x, y);
            const column = elemBelow?.closest('.kanban-column');
            if (column) column.classList.add('drag-over');
        }

        function completeDrag(x, y) {
            if (dragClone) {
                const elemBelow = document.elementFromPoint(x, y);
                const column = elemBelow?.closest('.kanban-column');

                if (column) {
                    const targetColumn = column.dataset.column;
                    if (targetColumn && sourceColumn !== targetColumn && draggedCardData) {
                        kanbanData[sourceColumn] = kanbanData[sourceColumn].filter(c => c.id !== draggedCardId);
                        const statusMap = { 'new': 'unpaid', 'inProgress': 'partial', 'awaitingPayment': 'unpaid', 'completed': 'paid' };
                        draggedCardData.status = statusMap[targetColumn];
                        kanbanData[targetColumn].push(draggedCardData);
                    }
                }

                dragClone.remove();
                dragClone = null;
            }

            if (dragSourceElement) {
                dragSourceElement.classList.remove('drag-source');
                dragSourceElement = null;
            }

            document.querySelectorAll('.kanban-column').forEach(col => col.classList.remove('drag-over'));

            isDragging = false;
            draggedCardId = null;
            draggedCardData = null;
            sourceColumn = null;

            render();
        }

        function cancelLongPress() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
            if (touchedCard?.element) {
                touchedCard.element.classList.remove('press-active');
            }
        }

        // === RENDER FUNCTIONS ===
        const renderHeader = () => `
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-3 sm:p-4 flex items-center gap-3 shadow-md">
                <button class="text-xl hover:bg-white/20 rounded-lg p-1 transition">‚Üê</button>
                <div class="flex-1">
                    <div class="font-semibold text-base sm:text-lg">–°—Ç—Ä–æ–π–ö–æ–Ω—Ç—Ä–æ–ª—å</div>
                    <div class="text-xs opacity-80">${{manager:'üë§ –ú–µ–Ω–µ–¥–∂–µ—Ä',accountant:'üìä –ë—É—Ö–≥–∞–ª—Ç–µ—Ä',owner:'üëë –°–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫',driver:'üöõ –í–æ–¥–∏—Ç–µ–ª—å'}[activeRole]}</div>
                </div>
                <button class="text-xl hover:bg-white/20 rounded-lg p-2 transition">‚ãÆ</button>
            </div>
        `;

        const renderRoleSwitcher = () => `
            <div class="bg-gray-50 p-2 flex gap-1 text-xs border-b overflow-x-auto">
                ${['manager', 'accountant', 'owner', 'driver'].map(role => `
                    <button onclick="setRole('${role}')" class="px-2 sm:px-3 py-1.5 rounded-lg transition font-medium whitespace-nowrap ${activeRole === role ? 'bg-blue-500 text-white shadow' : 'bg-white hover:bg-gray-100'}">
                        ${{manager:'–ú–µ–Ω–µ–¥–∂–µ—Ä',accountant:'–ë—É—Ö–≥–∞–ª—Ç–µ—Ä',owner:'–°–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫',driver:'–í–æ–¥–∏—Ç–µ–ª—å'}[role]}
                    </button>
                `).join('')}
            </div>
        `;

        const renderKanbanCard = (item, columnKey) => `
            <div class="kanban-card p-3 rounded-xl border-l-4 mb-2 bg-white shadow-sm ${getStatusColor(item.status)}"
                 draggable="true"
                 ondragstart="handleDragStart(event, ${item.id}, '${columnKey}')"
                 ondragend="handleDragEnd(event)"
                 ontouchstart="handleCardTouchStart(event, ${item.id}, '${columnKey}')"
                 ontouchmove="handleCardTouchMove(event)"
                 ontouchend="handleCardTouchEnd(event)"
                 data-card-id="${item.id}">
                <div class="flex items-start justify-between">
                    <div class="font-medium text-sm">${item.client}</div>
                    <span class="text-lg">${getTypeIcon(item.type)}</span>
                </div>
                <div class="text-xs text-gray-600 mt-1">${item.material}</div>
                <div class="text-sm font-bold mt-2">${item.price}</div>
                <div class="text-xs text-gray-500 mt-1 flex items-center gap-1">
                    üìç ${item.address.length > 20 ? item.address.substring(0, 20) + '...' : item.address}
                </div>
                ${item.daysOverdue ? `<div class="text-xs text-red-600 mt-1 font-medium">‚ö†Ô∏è –ü—Ä–æ—Å—Ä–æ—á–∫–∞ ${item.daysOverdue} –¥–Ω.</div>` : ''}
                ${item.comments?.length ? `<div class="text-xs text-blue-500 mt-2 flex items-center gap-1">üí¨ ${item.comments.length}</div>` : ''}
            </div>
        `;

        const renderFilters = () => `
            <div class="flex gap-2 mb-4 overflow-x-auto pb-2 px-1">
                ${[
                    { key: 'all', label: '–í—Å–µ', count: Object.values(kanbanData).flat().length },
                    { key: 'sypuchka', label: 'ü™® –°—ã–ø—É—á–∫–∞', count: Object.values(kanbanData).flat().filter(i => i.type === 'sypuchka').length },
                    { key: 'tech', label: 'üöú –¢–µ—Ö–Ω–∏–∫–∞', count: Object.values(kanbanData).flat().filter(i => i.type === 'tech').length },
                    { key: 'snow', label: '‚ùÑÔ∏è –°–Ω–µ–≥', count: Object.values(kanbanData).flat().filter(i => i.type === 'snow').length },
                ].map(f => `
                    <button onclick="setFilter('${f.key}')" class="filter-pill px-4 py-2 rounded-full text-sm font-medium shadow-sm ${activeFilter === f.key ? 'active' : 'bg-white hover:bg-gray-50'}">
                        ${f.label} <span class="ml-1 opacity-70">${f.count}</span>
                    </button>
                `).join('')}
            </div>
        `;

        const renderColumnDots = () => `
            <div class="column-dots">
                ${columnKeys.map((_, i) => `<div class="column-dot ${i === activeColumnIndex ? 'active' : ''}" onclick="scrollToColumn(${i})"></div>`).join('')}
            </div>
        `;

        const renderKanban = () => `
            <div class="p-3 sm:p-4">
                ${renderFilters()}
                <div class="kanban-container" id="kanbanContainer" onscroll="handleKanbanScroll()">
                    ${[
                        { key: 'new', title: 'üì• –ù–æ–≤–∞—è', bg: 'bg-gray-50' },
                        { key: 'inProgress', title: 'üîÑ –í —Ä–∞–±–æ—Ç–µ', bg: 'bg-blue-50' },
                        { key: 'awaitingPayment', title: 'üí∞ –û–ø–ª–∞—Ç–∞', bg: 'bg-yellow-50' },
                        { key: 'completed', title: '‚úÖ –ì–æ—Ç–æ–≤–æ', bg: 'bg-green-50' }
                    ].map(col => `
                        <div class="kanban-column ${col.bg} rounded-xl p-3" data-column="${col.key}"
                             ondragover="handleDragOver(event)" ondragenter="handleDragEnter(event)"
                             ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, '${col.key}')">
                            <div class="flex items-center justify-between mb-3">
                                <span class="font-semibold text-sm">${col.title}</span>
                                <span class="bg-white px-2 py-0.5 rounded-full text-xs font-medium shadow-sm">${getColumnCount(col.key)}</span>
                            </div>
                            <div class="min-h-[200px]">
                                ${getFilteredData(kanbanData[col.key]).map(item => renderKanbanCard(item, col.key)).join('')}
                                ${col.key === 'new' ? `<button onclick="setScreen('create')" class="w-full py-3 border-2 border-dashed border-gray-300 rounded-xl text-gray-400 text-sm hover:border-blue-400 hover:text-blue-400 transition">+ –î–æ–±–∞–≤–∏—Ç—å</button>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
                ${renderColumnDots()}
                <div class="text-center text-xs text-gray-400 mt-2 lg:hidden">
                    –¢–∞–ø ‚Äî –æ—Ç–∫—Ä—ã—Ç—å ‚Ä¢ –ó–∞–∂–∞—Ç—å ‚Äî –ø–µ—Ä–µ—Ç–∞—â–∏—Ç—å
                </div>
            </div>
        `;

        const renderCardModal = () => {
            if (!selectedCardId) return '';
            const result = findCard(selectedCardId);
            if (!result) return '';
            const { card } = result;
            
            return `
                <div class="fixed inset-0 z-50 flex items-end sm:items-center justify-center modal-overlay" onclick="closeCardModal(event)">
                    <div class="modal-content bg-white w-full sm:w-[480px] sm:max-w-[90vw] max-h-[85vh] rounded-t-2xl sm:rounded-2xl shadow-xl flex flex-col" onclick="event.stopPropagation()">
                        <div class="p-4 border-b flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <span class="text-2xl">${getTypeIcon(card.type)}</span>
                                    <span class="font-bold text-lg">${card.client}</span>
                                </div>
                                <div class="text-sm text-gray-600 mt-1">${card.material}</div>
                            </div>
                            <button onclick="closeCardModal()" class="text-gray-400 hover:text-gray-600 text-2xl leading-none p-1">&times;</button>
                        </div>
                        
                        <div class="p-4 border-b">
                            <div class="grid grid-cols-2 gap-3 text-sm">
                                <div>
                                    <div class="text-gray-500">–°—É–º–º–∞</div>
                                    <div class="font-bold text-lg">${card.price}</div>
                                </div>
                                <div>
                                    <div class="text-gray-500">–°—Ç–∞—Ç—É—Å</div>
                                    <div class="inline-block px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(card.status)}">
                                        ${{paid:'–û–ø–ª–∞—á–µ–Ω–æ',partial:'–ß–∞—Å—Ç–∏—á–Ω–æ',unpaid:'–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ'}[card.status]}
                                    </div>
                                </div>
                                <div class="col-span-2">
                                    <div class="text-gray-500">–ê–¥—Ä–µ—Å</div>
                                    <div class="flex items-center gap-2">
                                        <span>${card.address}</span>
                                        <button class="text-blue-500 text-xs">üìç –ö–∞—Ä—Ç–∞</button>
                                    </div>
                                </div>
                                <div class="col-span-2">
                                    <div class="text-gray-500">–¢–µ–ª–µ—Ñ–æ–Ω</div>
                                    <a href="tel:${card.phone}" class="text-blue-500">${card.phone}</a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex-1 overflow-auto p-4">
                            <div class="font-medium mb-3 flex items-center gap-2">
                                üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                                <span class="text-xs text-gray-400">${card.comments?.length || 0}</span>
                            </div>
                            
                            <div class="space-y-3 mb-4" id="commentsContainer">
                                ${card.comments?.length ? card.comments.map(c => `
                                    <div class="comment-item bg-gray-50 rounded-lg p-3">
                                        <div class="flex items-center justify-between mb-1">
                                            <span class="font-medium text-sm">${c.author}</span>
                                            <span class="text-xs text-gray-400">${c.time}</span>
                                        </div>
                                        <div class="text-sm text-gray-700">${c.text}</div>
                                    </div>
                                `).join('') : `
                                    <div class="text-center text-gray-400 text-sm py-4">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>
                                `}
                            </div>
                        </div>
                        
                        <div class="p-4 border-t bg-gray-50">
                            <div class="flex gap-2">
                                <input type="text" id="commentInput" 
                                       class="flex-1 px-3 py-2 border rounded-xl text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                       placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."
                                       onkeypress="if(event.key==='Enter')addComment()">
                                <button onclick="addComment()" class="px-4 py-2 bg-blue-500 text-white rounded-xl text-sm font-medium hover:bg-blue-600 transition">‚Üí</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderCreateForm = () => `
            <div class="p-3 sm:p-4">
                <div class="text-lg sm:text-xl font-bold mb-4">–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</div>
                <div class="mb-5">
                    <div class="text-sm text-gray-600 mb-2 font-medium">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
                    <div class="flex gap-2">
                        <button class="flex-1 py-3 bg-blue-500 text-white rounded-xl text-sm font-medium shadow-sm">ü™® –°—ã–ø—É—á–∫–∞</button>
                        <button class="flex-1 py-3 bg-white rounded-xl text-sm shadow-sm hover:bg-gray-50 border">üöú –¢–µ—Ö–Ω–∏–∫–∞</button>
                        <button class="flex-1 py-3 bg-white rounded-xl text-sm shadow-sm hover:bg-gray-50 border">‚ùÑÔ∏è –°–Ω–µ–≥</button>
                    </div>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="text-sm text-gray-600 font-medium">–ö–ª–∏–µ–Ω—Ç / –ö–æ–Ω—Ç–∞–∫—Ç</label>
                        <input type="text" class="w-full p-3 border rounded-xl mt-1 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="–û–û–û –∏–ª–∏ –§–ò–û + —Ç–µ–ª–µ—Ñ–æ–Ω">
                    </div>
                    <div>
                        <label class="text-sm text-gray-600 font-medium">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                        <div class="flex gap-2 mt-1">
                            <input type="text" class="flex-1 p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="—É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, –¥. 1">
                            <button class="px-4 bg-gray-100 rounded-xl hover:bg-gray-200 transition text-xl">üìç</button>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <div class="flex-1">
                            <label class="text-sm text-gray-600 font-medium">–ú–∞—Ç–µ—Ä–∏–∞–ª</label>
                            <select class="w-full p-3 border rounded-xl mt-1 bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                                <option>–©–µ–±–µ–Ω—å 5-20</option><option>–©–µ–±–µ–Ω—å 20-40</option><option>–ü–µ—Å–æ–∫ –∫–∞—Ä—å–µ—Ä–Ω—ã–π</option>
                            </select>
                        </div>
                        <div class="w-24">
                            <label class="text-sm text-gray-600 font-medium">–û–±—ä—ë–º</label>
                            <input type="text" class="w-full p-3 border rounded-xl mt-1 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="20—Ç">
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <div class="flex-1">
                            <label class="text-sm text-gray-600 font-medium">–¶–µ–Ω–∞, ‚ÇΩ</label>
                            <input type="text" class="w-full p-3 border rounded-xl mt-1 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="45 000">
                        </div>
                        <div class="flex-1">
                            <label class="text-sm text-gray-600 font-medium">–û–ø–ª–∞—Ç–∞</label>
                            <select class="w-full p-3 border rounded-xl mt-1 bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                                <option>–ù–∞–ª–∏—á–Ω—ã–µ</option><option>–ë–µ–∑–Ω–∞–ª</option><option>–ö–∞—Ä—Ç–∞</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm text-gray-600 font-medium">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                        <textarea class="w-full p-3 border rounded-xl mt-1 focus:ring-2 focus:ring-blue-500 outline-none resize-none" rows="2" placeholder="–î–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>
                    </div>
                </div>
                <button class="w-full mt-6 py-4 bg-blue-500 text-white rounded-xl font-semibold shadow-md hover:bg-blue-600 transition">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
            </div>
        `;

        const renderDriverScreen = () => `
            <div class="p-3 sm:p-4">
                <div class="flex items-center justify-between mb-5">
                    <div>
                        <div class="text-lg sm:text-xl font-bold">–ú–æ–∏ –∑–∞–¥–∞—á–∏</div>
                        <div class="text-sm text-gray-500">–°–µ–≥–æ–¥–Ω—è, 18 –¥–µ–∫–∞–±—Ä—è</div>
                    </div>
                    <div class="text-right bg-blue-50 rounded-xl p-3">
                        <div class="text-2xl">üöõ</div>
                        <div class="text-xs text-blue-600 font-medium">–ö–ê–ú–ê–ó-001</div>
                    </div>
                </div>
                <div class="space-y-3">
                    ${[
                        { client: '–û–û–û "–°—Ç—Ä–æ–π–∫–∞"', material: '–©–µ–±–µ–Ω—å 20—Ç', time: '08:00', address: '—É–ª. –õ–µ–Ω–∏–Ω–∞, 15', status: 'done' },
                        { client: '–ò–ü –°–∏–¥–æ—Ä–æ–≤', material: '–ü–µ—Å–æ–∫ 15—Ç', time: '12:00', address: '–ü—Ä–æ–º–∑–æ–Ω–∞, —É—á. 8', status: 'current' },
                        { client: '–ñ–ö "–°–æ–ª–Ω–µ—á–Ω—ã–π"', material: '–©–µ–±–µ–Ω—å 25—Ç', time: '15:00', address: '–ñ–ö –°–æ–ª–Ω–µ—á–Ω—ã–π', status: 'pending' },
                    ].map(task => `
                        <div class="${task.status === 'done' ? 'bg-green-50 border-green-200' : task.status === 'current' ? 'bg-blue-50 border-2 border-blue-400' : 'bg-white border-gray-200'} border rounded-xl p-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="text-xs font-semibold ${task.status === 'done' ? 'text-green-600' : task.status === 'current' ? 'text-blue-600' : 'text-gray-400'}">
                                        ${task.status === 'done' ? '‚úì –í–´–ü–û–õ–ù–ï–ù–û' : task.status === 'current' ? '‚óè –¢–ï–ö–£–©–ê–Ø' : '–°–õ–ï–î–£–Æ–©–ê–Ø'}
                                    </div>
                                    <div class="font-semibold mt-1">${task.client}</div>
                                    <div class="text-sm text-gray-600">${task.material}</div>
                                </div>
                                <div class="text-lg font-bold ${task.status === 'current' ? 'text-blue-600' : ''}">${task.time}</div>
                            </div>
                            <div class="mt-3 text-sm text-gray-500">üìç ${task.address}</div>
                            ${task.status === 'current' ? `<button class="w-full mt-3 py-3 bg-blue-500 text-white rounded-xl text-sm font-medium">üó∫Ô∏è –û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä–µ</button>` : ''}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;

        const resources = [
            { id: 1, name: '–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä JCB', icon: 'üöú' },
            { id: 2, name: '–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä CAT', icon: 'üöú' },
            { id: 3, name: '–ù–∞—Å–æ—Å –±–µ—Ç–æ–Ω–∞ ‚Ññ1', icon: 'üîß' },
            { id: 4, name: '–ù–∞—Å–æ—Å –±–µ—Ç–æ–Ω–∞ ‚Ññ2', icon: 'üîß' },
            { id: 5, name: '–ö–ê–ú–ê–ó-001', icon: 'üöõ' },
            { id: 6, name: '–ö–ê–ú–ê–ó-002', icon: 'üöõ' },
        ];

        const timeSlots = ['08:00', '10:00', '12:00', '14:00', '16:00', '18:00'];
        
        const bookings = [
            { resourceId: 1, start: 0, duration: 2, client: '–ò–≤–∞–Ω–æ–≤', status: 'unpaid' },
            { resourceId: 3, start: 2, duration: 3, client: '–ë–µ—Ç–æ–Ω+', status: 'paid' },
            { resourceId: 5, start: 1, duration: 2, client: '–°—Ç—Ä–æ–π–∫–∞', status: 'partial' },
            { resourceId: 2, start: 3, duration: 2, client: '–ñ–ö –°–æ–ª–Ω–µ—á–Ω—ã–π', status: 'paid' },
            { resourceId: 6, start: 0, duration: 1, client: '–ü–µ—Ç—Ä–æ–≤', status: 'unpaid' },
            { resourceId: 4, start: 4, duration: 2, client: '–§–∞—Å–∞–¥', status: 'partial' },
        ];

        const getStatusBg = (status) => ({
            paid: 'bg-green-500', partial: 'bg-yellow-500', unpaid: 'bg-red-500'
        }[status] || 'bg-gray-500');

        const renderSchedule = () => `
            <div class="p-3 sm:p-4">
                <div class="flex items-center justify-between mb-4">
                    <button class="p-2 bg-white rounded-lg shadow-sm hover:bg-gray-50 transition">‚Üê</button>
                    <div class="text-center">
                        <div class="font-bold">–°–µ–≥–æ–¥–Ω—è, 18 –¥–µ–∫–∞–±—Ä—è</div>
                        <div class="text-xs text-gray-500">–ß–µ—Ç–≤–µ—Ä–≥</div>
                    </div>
                    <button class="p-2 bg-white rounded-lg shadow-sm hover:bg-gray-50 transition">‚Üí</button>
                </div>

                <div class="flex gap-4 mb-4 text-xs justify-center flex-wrap">
                    <span class="flex items-center gap-1"><span class="w-3 h-3 bg-green-500 rounded-sm"></span> –û–ø–ª–∞—á–µ–Ω–æ</span>
                    <span class="flex items-center gap-1"><span class="w-3 h-3 bg-yellow-500 rounded-sm"></span> –ß–∞—Å—Ç–∏—á–Ω–æ</span>
                    <span class="flex items-center gap-1"><span class="w-3 h-3 bg-red-500 rounded-sm"></span> –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ</span>
                </div>

                <div class="overflow-x-auto rounded-xl border bg-white shadow-sm">
                    <div style="min-width: 520px">
                        <div class="flex border-b bg-gray-50">
                            <div class="w-28 sm:w-32 p-2 sm:p-3 font-medium text-xs text-gray-600">–†–µ—Å—É—Ä—Å</div>
                            ${timeSlots.map(time => `
                                <div class="flex-1 p-2 sm:p-3 text-center text-xs font-medium border-l text-gray-600">${time}</div>
                            `).join('')}
                        </div>

                        ${resources.map(resource => `
                            <div class="flex border-b last:border-b-0 relative" style="height: 48px">
                                <div class="w-28 sm:w-32 p-2 bg-gray-50 text-xs flex items-center gap-1 border-r">
                                    <span>${resource.icon}</span>
                                    <span class="truncate font-medium">${resource.name}</span>
                                </div>
                                <div class="flex-1 relative">
                                    <div class="absolute inset-0 flex">
                                        ${timeSlots.map(() => `
                                            <div class="flex-1 border-l border-gray-100 hover:bg-blue-50 cursor-pointer"></div>
                                        `).join('')}
                                    </div>
                                    ${bookings
                                        .filter(b => b.resourceId === resource.id)
                                        .map(booking => `
                                            <div class="absolute top-1 bottom-1 rounded-lg ${getStatusBg(booking.status)} text-white text-xs flex items-center justify-center px-2 font-medium shadow-sm cursor-pointer hover:opacity-90"
                                                 style="left: calc(${(booking.start / timeSlots.length) * 100}% + 2px); width: calc(${(booking.duration / timeSlots.length) * 100}% - 4px)">
                                                ${booking.client}
                                            </div>
                                        `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <button onclick="setScreen('create')" class="fixed bottom-24 right-4 w-14 h-14 bg-blue-500 text-white rounded-full shadow-lg text-2xl hover:bg-blue-600 transition active:scale-95 z-10">
                    +
                </button>
            </div>
        `;

        const renderDebtors = () => `
            <div class="p-3 sm:p-4">
                <div class="bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl p-4 mb-4 shadow-md">
                    <div class="text-sm opacity-90">–û–±—â–∞—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å</div>
                    <div class="text-2xl font-bold mt-1">263 500 ‚ÇΩ</div>
                    <div class="text-xs opacity-75 mt-1">7 –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö —Å–¥–µ–ª–æ–∫</div>
                </div>
                <div class="space-y-3">
                    ${[
                        { client: '–û–û–û "–ë–µ—Ç–æ–Ω+"', total: '152 000 ‚ÇΩ', overdue: '12 –¥–Ω–µ–π', deals: 3 },
                        { client: '–ò–ü –ü–µ—Ç—Ä–æ–≤', total: '45 000 ‚ÇΩ', overdue: '8 –¥–Ω–µ–π', deals: 1 },
                        { client: '–°—Ç—Ä–æ–π—Å–µ—Ä–≤–∏—Å', total: '38 500 ‚ÇΩ', overdue: '5 –¥–Ω–µ–π', deals: 2 },
                    ].map(d => `
                        <div class="bg-white border border-red-100 rounded-xl p-4 flex justify-between items-center shadow-sm">
                            <div>
                                <div class="font-semibold">${d.client}</div>
                                <div class="text-xs text-gray-500">${d.deals} —Å–¥–µ–ª–æ–∫ ‚Ä¢ –ü—Ä–æ—Å—Ä–æ—á–∫–∞ ${d.overdue}</div>
                            </div>
                            <div class="font-bold text-red-600">${d.total}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;

        const renderBottomNav = () => {
            if (activeRole === 'driver') return '';
            const items = [
                { key: 'kanban', icon: 'üìã', label: '–ó–∞—è–≤–∫–∏' },
                { key: 'schedule', icon: 'üìÖ', label: '–ì—Ä–∞—Ñ–∏–∫' },
                { key: 'create', icon: '‚ûï', label: '–°–æ–∑–¥–∞—Ç—å' },
            ];
            if (activeRole === 'accountant' || activeRole === 'owner') items.push({ key: 'debtors', icon: 'üí∞', label: '–î–æ–ª–≥–∏' });
            
            return `
                <div class="bg-white border-t flex">
                    ${items.map(item => `
                        <button onclick="setScreen('${item.key}')" class="flex-1 py-3 text-center ${activeScreen === item.key ? 'text-blue-500' : 'text-gray-400'}">
                            <div class="text-xl">${item.icon}</div>
                            <div class="text-xs font-medium">${item.label}</div>
                        </button>
                    `).join('')}
                </div>
            `;
        };

        const renderContent = () => {
            if (activeRole === 'driver') return renderDriverScreen();
            switch(activeScreen) {
                case 'kanban': return renderKanban();
                case 'schedule': return renderSchedule();
                case 'debtors': return renderDebtors();
                case 'create': return renderCreateForm();
                default: return renderKanban();
            }
        };

        const render = () => {
            document.getElementById('app').innerHTML = `
                ${renderHeader()}
                ${renderRoleSwitcher()}
                <div class="flex-1 overflow-auto bg-gray-50">${renderContent()}</div>
                ${renderBottomNav()}
                ${renderCardModal()}
            `;
        };

        // === EVENT HANDLERS ===
        window.setScreen = (screen) => { activeScreen = screen; render(); };
        window.setRole = (role) => { 
            activeRole = role; 
            if (role === 'driver') activeScreen = 'driver'; 
            else if (activeScreen === 'driver') activeScreen = 'kanban'; 
            render(); 
        };
        window.setFilter = (filter) => { activeFilter = filter; render(); };
        
        window.scrollToColumn = (index) => {
            const container = document.getElementById('kanbanContainer');
            const columns = container?.querySelectorAll('.kanban-column');
            if (columns?.[index]) { 
                columns[index].scrollIntoView({ behavior: 'smooth', inline: 'start' }); 
                activeColumnIndex = index; 
                updateColumnDots(); 
            }
        };

        window.handleKanbanScroll = () => {
            const container = document.getElementById('kanbanContainer');
            const columnWidth = container?.querySelector('.kanban-column')?.offsetWidth || 0;
            if (columnWidth) {
                activeColumnIndex = Math.round(container.scrollLeft / columnWidth);
                updateColumnDots();
            }
        };

        const updateColumnDots = () => {
            document.querySelectorAll('.column-dot').forEach((dot, i) => dot.classList.toggle('active', i === activeColumnIndex));
        };

        window.openCardModal = (cardId) => { selectedCardId = cardId; render(); };
        
        window.closeCardModal = (e) => {
            if (e && e.target !== e.currentTarget) return;
            selectedCardId = null;
            render();
        };

        window.addComment = () => {
            const input = document.getElementById('commentInput');
            const text = input?.value?.trim();
            if (!text || !selectedCardId) return;
            
            const result = findCard(selectedCardId);
            if (result) {
                if (!result.card.comments) result.card.comments = [];
                result.card.comments.push({ author: getRoleName(), text, time: getCurrentTime() });
                render();
                setTimeout(() => {
                    const container = document.getElementById('commentsContainer');
                    if (container) container.scrollTop = container.scrollHeight;
                }, 50);
            }
        };

        // Init
        render();
    </script>
</body>
</html>
